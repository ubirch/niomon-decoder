package com.ubirch.decoding

import java.io.ByteArrayInputStream
import java.util.{Base64, UUID}

import com.typesafe.config.ConfigFactory
import com.typesafe.scalalogging.StrictLogging
import com.ubirch.client.protocol.DefaultProtocolVerifier
import com.ubirch.client.util.curveFromString
import com.ubirch.crypto.{GeneratorKeyFactory, PubKey}
import com.ubirch.niomon.base.{NioMicroservice, NioMicroserviceMock}
import com.ubirch.kafka.RichAnyProducerRecord
import javax.xml.bind.DatatypeConverter
import org.apache.commons.codec.binary.Hex
import org.apache.kafka.clients.producer.ProducerRecord
import org.apache.kafka.common.serialization.{ByteArrayDeserializer, ByteArraySerializer}
import org.json4s.Formats
import org.json4s.jackson.JsonMethods.parse
import org.scalatest.{FlatSpec, Matchers}


class RoutingTest extends FlatSpec with Matchers with StrictLogging {

  implicit val formats: Formats = com.ubirch.kafka.formats

  implicit val bytesSerializer: ByteArraySerializer = new ByteArraySerializer
  implicit val byteDeserializer: ByteArrayDeserializer = new ByteArrayDeserializer

  private val v2HardwareId = "6eac4d0b-16e6-4508-8c46-22e7451ea5a1"
  private val v2MsgPackHex = "9522c4106eac4d0b16e645088c4622e7451ea5a100c4206b86b273ff34fce19d6b804eff5a3f5747ada4eaa22f1d49c01e52ddb7875b4bc440bc2a01322c679b9648a9391704e992c041053404aafcdab08fc4ce54a57eb16876d741918d01219abf2dc7913f2d9d49439d350f11d05cdb3f85972ac95c45fc"

  private val v1HardwareId = "946ba755-e132-4680-a380-7be395eb8ccd"
  private val v1MsgPackHex = "9613b0946ba755e1324680a3807be395eb8ccdda004001d3c78a7bc8738cbabee96ae86651c89aa81252dee0e7c7f3457324202aae9c3d16332d3d7ecde72fa26801a081b6347148bae6ab22b8830c360d78d0b63f0e00a50102030405da0040b30fa8a898282878862e15ed871f6618043fb7c2400daed1bdf7bad5c790edd5b011d248be2ee04bc086b02bd9c337b981eeaff1eefca47d346132ab4cfd8006"

  private val trackleHardwareId = "7aa42ea9-f981-91a6-9b9c-b14aacabce54"
  private val trackleMsgPack = "96cd0013b07aa42ea9f98191a69b9cb14aacabce54da0040863af1a1ed5d1051566ab79897347b36b86cf2553efb8509a13e440276e3327653f9d02a09ab2904803dfd6b632972f110b32090f3a706592054c5ad792ce1025495da002376312e302e322d50524f442d3230313830333236313033323035202876352e362e3629cd15aa03de01edce5ebb05ebcd0e6ace5ebb0627cd0e6ace5ebb0663cd0e6ace5ebb069fcd0e6ace5ebb06dbcd0e69ce5ebb0717cd0e69ce5ebb0753cd0e68ce5ebb078fcd0e69ce5ebb07cbcd0e67ce5ebb0807cd0e65ce5ebb0843cd0e64ce5ebb087fcd0e64ce5ebb08bbcd0e64ce5ebb08f7cd0e61ce5ebb0933cd0e5fce5ebb096fcd0e5fce5ebb09abcd0e5dce5ebb09e7cd0e5ece5ebb0a23cd0e5ece5ebb0a5fcd0e5cce5ebb0a9bcd0e5bce5ebb0ad7cd0e59ce5ebb0b13cd0e57ce5ebb0b4fcd0e55ce5ebb0b8bcd0e54ce5ebb0bc7cd0e55ce5ebb0c03cd0e53ce5ebb0c3fcd0e55ce5ebb0c7bcd0e56ce5ebb0cb7cd0e54ce5ebb0cf3cd0e52ce5ebb0d2fcd0e52ce5ebb0d6bcd0e52ce5ebb0da7cd0e55ce5ebb0de3cd0e56ce5ebb0e1fcd0e54ce5ebb0e5bcd0e54ce5ebb0e97cd0e54ce5ebb0ed3cd0e54ce5ebb0f0fcd0e56ce5ebb0f4bcd0e54ce5ebb0f87cd0e56ce5ebb0fc3cd0e56ce5ebb0fffcd0e57ce5ebb103bcd0e57ce5ebb1077cd0e59ce5ebb10b3cd0e57ce5ebb10efcd0e55ce5ebb112bcd0e57ce5ebb1167cd0e56ce5ebb11a3cd0e57ce5ebb11dfcd0e55ce5ebb121bcd0e56ce5ebb1257cd0e55ce5ebb1293cd0e56ce5ebb12cfcd0e54ce5ebb130bcd0e52ce5ebb1347cd0e52ce5ebb1383cd0e52ce5ebb13bfcd0e52ce5ebb13fbcd0e54ce5ebb1437cd0e54ce5ebb1473cd0e54ce5ebb14afcd0e54ce5ebb14ebcd0e53ce5ebb1527cd0e54ce5ebb1563cd0e52ce5ebb159fcd0e52ce5ebb15dbcd0e51ce5ebb1617cd0e54ce5ebb1653cd0e52ce5ebb168fcd0e52ce5ebb16cbcd0e52ce5ebb1707cd0e52ce5ebb1743cd0e51ce5ebb177fcd0e52ce5ebb17bbcd0e51ce5ebb17f7cd0e52ce5ebb1833cd0e53ce5ebb186fcd0e55ce5ebb18abcd0e52ce5ebb18e7cd0e54ce5ebb1923cd0e53ce5ebb195fcd0e52ce5ebb199bcd0e53ce5ebb19d7cd0e54ce5ebb1a13cd0e55ce5ebb1a4fcd0e54ce5ebb1a8bcd0e54ce5ebb1ac7cd0e53ce5ebb1b03cd0e55ce5ebb1b3fcd0e53ce5ebb1b7bcd0e54ce5ebb1bb7cd0e53ce5ebb1bf3cd0e56ce5ebb1c2fcd0e53ce5ebb1c6bcd0e55ce5ebb1ca7cd0e56ce5ebb1ce3cd0e59ce5ebb1d1fcd0e59ce5ebb1d5bcd0e57ce5ebb1d97cd0e56ce5ebb1dd3cd0e54ce5ebb1e0fcd0e57ce5ebb1e4bcd0e59ce5ebb1e87cd0e56ce5ebb1ec3cd0e56ce5ebb1effcd0e56ce5ebb1f3bcd0e59ce5ebb1f77cd0e56ce5ebb1fb3cd0e59ce5ebb1fefcd0e59ce5ebb202bcd0e57ce5ebb2067cd0e5ace5ebb20a3cd0e5bce5ebb20dfcd0e5ace5ebb211bcd0e5ace5ebb2157cd0e5cce5ebb2193cd0e5bce5ebb21cfcd0e5bce5ebb220bcd0e5bce5ebb2247cd0e5dce5ebb2283cd0e5dce5ebb22bfcd0e5cce5ebb22fbcd0e5bce5ebb2337cd0e59ce5ebb2373cd0e5bce5ebb23afcd0e5cce5ebb23ebcd0e5cce5ebb2427cd0e5cce5ebb2463cd0e5dce5ebb249fcd0e5dce5ebb24dbcd0e5dce5ebb2517cd0e5dce5ebb2553cd0e5ece5ebb258fcd0e60ce5ebb25cbcd0e5fce5ebb2607cd0e5fce5ebb2643cd0e5fce5ebb267fcd0e5ece5ebb26bbcd0e5ece5ebb26f7cd0e5dce5ebb2733cd0e5fce5ebb276fcd0e61ce5ebb27abcd0e61ce5ebb27e7cd0e5ece5ebb2823cd0e5fce5ebb285fcd0e61ce5ebb289bcd0e62ce5ebb28d7cd0e62ce5ebb2913cd0e60ce5ebb294fcd0e62ce5ebb298bcd0e62ce5ebb29c7cd0e62ce5ebb2a03cd0e61ce5ebb2a3fcd0e62ce5ebb2a7bcd0e63ce5ebb2ab7cd0e62ce5ebb2af3cd0e63ce5ebb2b2fcd0e64ce5ebb2b6bcd0e62ce5ebb2ba7cd0e64ce5ebb2be3cd0e64ce5ebb2c1fcd0e63ce5ebb2c5bcd0e64ce5ebb2c97cd0e67ce5ebb2cd3cd0e65ce5ebb2d0fcd0e64ce5ebb2d4bcd0e68ce5ebb2d87cd0e68ce5ebb2dc3cd0e67ce5ebb2dffcd0e68ce5ebb2e3bcd0e68ce5ebb2e77cd0e69ce5ebb2eb3cd0e69ce5ebb2eefcd0e69ce5ebb2f2bcd0e69ce5ebb2f67cd0e6cce5ebb2fa3cd0e6bce5ebb2fdfcd0e6bce5ebb301bcd0e6cce5ebb3057cd0e6dce5ebb3093cd0e6cce5ebb30cfcd0e6dce5ebb310bcd0e6ece5ebb3147cd0e6fce5ebb3183cd0e6ece5ebb31bfcd0e6fce5ebb31fbcd0e6dce5ebb3237cd0e6fce5ebb3273cd0e6fce5ebb32afcd0e6fce5ebb32ebcd0e6fce5ebb3327cd0e6ece5ebb3363cd0e6fce5ebb339fcd0e6fce5ebb33dbcd0e6ece5ebb3417cd0e6fce5ebb3453cd0e6dce5ebb348fcd0e6ece5ebb34cbcd0e6fce5ebb3507cd0e6fce5ebb3543cd0e6fce5ebb357fcd0e72ce5ebb35bbcd0e72ce5ebb35f7cd0e70ce5ebb3633cd0e6fce5ebb366fcd0e70ce5ebb36abcd0e70ce5ebb36e7cd0e71ce5ebb3723cd0e71ce5ebb375fcd0e71ce5ebb379bcd0e72ce5ebb37d7cd0e74ce5ebb3813cd0e71ce5ebb384fcd0e73ce5ebb388bcd0e74ce5ebb38c7cd0e74ce5ebb3903cd0e73ce5ebb393fcd0e72ce5ebb397bcd0e70ce5ebb39b7cd0e72ce5ebb39f3cd0e72ce5ebb3a2fcd0e71ce5ebb3a6bcd0e74ce5ebb3aa7cd0e6fce5ebb3ae3cd0e72ce5ebb3b1fcd0e70ce5ebb3b5bcd0e71ce5ebb3b97cd0e71ce5ebb3bd3cd0e70ce5ebb3c0fcd0e6fce5ebb3c4bcd0e6fce5ebb3c87cd0e6ece5ebb3cc3cd0e6cce5ebb3cffcd0e6cce5ebb3d3bcd0e6cce5ebb3d77cd0e6ece5ebb3db3cd0e6bce5ebb3defcd0e6ace5ebb3e2bcd0e6dce5ebb3e67cd0e69ce5ebb3ea3cd0e69ce5ebb3edfcd0e6ace5ebb3f1bcd0e69ce5ebb3f57cd0e6ace5ebb3f93cd0e67ce5ebb3fcfcd0e67ce5ebb400bcd0e67ce5ebb4047cd0e63ce5ebb4083cd0e64ce5ebb40bfcd0e62ce5ebb40fbcd0e62ce5ebb4137cd0e63ce5ebb4173cd0e62ce5ebb41afcd0e62ce5ebb41ebcd0e61ce5ebb4227cd0e5ece5ebb4263cd0e5fce5ebb429fcd0e5fce5ebb42dbcd0e60ce5ebb4317cd0e5ece5ebb4353cd0e5dce5ebb438fcd0e5cce5ebb43cbcd0e5bce5ebb4407cd0e5bce5ebb4443cd0e5ace5ebb447fcd0e5bce5ebb44bbcd0e5cce5ebb44f7cd0e5cce5ebb4533cd0e5dce5ebb456fcd0e60ce5ebb45abcd0e5dce5ebb45e7cd0e5ece5ebb4623cd0e60ce5ebb465fcd0e5ece5ebb469bcd0e5dce5ebb46d7cd0e5cce5ebb4713cd0e5fce5ebb474fcd0e5fce5ebb478bcd0e5ece5ebb47c7cd0e5ece5ebb4803cd0e5fce5ebb483fcd0e60ce5ebb487bcd0e5fce5ebb48b7cd0e5ece5ebb48f3cd0e5ece5ebb492fcd0e5ece5ebb496bcd0e5ece5ebb49a7cd0e60ce5ebb49e3cd0e60ce5ebb4a1fcd0e5ece5ebb4a5bcd0e5fce5ebb4a97cd0e5ece5ebb4ad3cd0e5ece5ebb4b0fcd0e5ece5ebb4b4bcd0e5ece5ebb4b87cd0e5dce5ebb4bc3cd0e5ece5ebb4bffcd0e5fce5ebb4c3bcd0e5ece5ebb4c77cd0e5dce5ebb4cb3cd0e5ece5ebb4cefcd0e5dce5ebb4d2bcd0e60ce5ebb4d67cd0e5dce5ebb4da3cd0e5ece5ebb4ddfcd0e60ce5ebb4e1bcd0e5ece5ebb4e57cd0e60ce5ebb4e93cd0e5dce5ebb4ecfcd0e5ece5ebb4f0bcd0e5ece5ebb4f47cd0e5fce5ebb4f83cd0e5ece5ebb4fbfcd0e5fce5ebb4ffccd0e5ece5ebb5038cd0e5ece5ebb5074cd0e5ece5ebb50b0cd0e5dce5ebb50eccd0e5dce5ebb5128cd0e5ece5ebb5164cd0e5dce5ebb51a0cd0e5ece5ebb51dccd0e5cce5ebb5218cd0e5ece5ebb5254cd0e5ece5ebb5290cd0e5dce5ebb52cccd0e5dce5ebb5308cd0e5ece5ebb5344cd0e5dce5ebb5380cd0e5ece5ebb53bccd0e5ece5ebb53f8cd0e5ece5ebb5434cd0e5ece5ebb5470cd0e5dce5ebb54accd0e5ece5ebb54e8cd0e5ece5ebb5524cd0e5dce5ebb5560cd0e5ece5ebb559ccd0e5dce5ebb55d8cd0e5ece5ebb5614cd0e5dce5ebb5650cd0e5dce5ebb568ccd0e5fce5ebb56c8cd0e5ece5ebb5704cd0e5ece5ebb5740cd0e5cce5ebb577ccd0e5dce5ebb57b8cd0e5ece5ebb57f4cd0e5ece5ebb5830cd0e5cce5ebb586ccd0e5dce5ebb58a8cd0e5cce5ebb58e4cd0e5dce5ebb5920cd0e5dce5ebb595ccd0e5ece5ebb5998cd0e5fce5ebb59d4cd0e60ce5ebb5a10cd0e5dce5ebb5a4ccd0e5bce5ebb5a88cd0e5dce5ebb5ac4cd0e5cce5ebb5b00cd0e5dce5ebb5b3ccd0e5ece5ebb5b78cd0e5ece5ebb5bb4cd0e5dce5ebb5bf0cd0e5dce5ebb5c2ccd0e5ece5ebb5c68cd0e5dce5ebb5ca4cd0e5dce5ebb5ce0cd0e5ece5ebb5d1ccd0e5fce5ebb5d58cd0e61ce5ebb5d94cd0e60ce5ebb5dd0cd0e61ce5ebb5e0ccd0e5ece5ebb5e48cd0e5fce5ebb5e84cd0e5ece5ebb5ec0cd0e5dce5ebb5efccd0e5fce5ebb5f38cd0e5dce5ebb5f74cd0e5ece5ebb5fb0cd0e5ece5ebb5feccd0e60ce5ebb6028cd0e5fce5ebb6064cd0e61ce5ebb60a0cd0e61ce5ebb60dccd0e62ce5ebb6118cd0e62ce5ebb6154cd0e62ce5ebb6190cd0e64ce5ebb61cccd0e62ce5ebb6208cd0e64ce5ebb6244cd0e65ce5ebb6280cd0e65ce5ebb62bccd0e65ce5ebb62f8cd0e65ce5ebb6334cd0e67ce5ebb6370cd0e63ce5ebb63accd0e65ce5ebb63e8cd0e63ce5ebb6424cd0e64ce5ebb6460cd0e63ce5ebb649ccd0e64ce5ebb64d8cd0e64ce5ebb6514cd0e69ce5ebb6550cd0e65ce5ebb658ccd0e67ce5ebb65c8cd0e65ce5ebb6604cd0e67ce5ebb6640cd0e67ce5ebb667ccd0e67ce5ebb66b8cd0e67ce5ebb66f4cd0e67ce5ebb6730cd0e67ce5ebb676ccd0e67ce5ebb67a8cd0e64ce5ebb67e4cd0e64ce5ebb6820cd0e67ce5ebb685ccd0e64ce5ebb6898cd0e64ce5ebb68d4cd0e67ce5ebb6910cd0e65ce5ebb694ccd0e67ce5ebb6988cd0e68ce5ebb69c4cd0e68ce5ebb6a00cd0e67ce5ebb6a3ccd0e69ce5ebb6a78cd0e68ce5ebb6ab4cd0e67ce5ebb6af0cd0e68ce5ebb6b2ccd0e68ce5ebb6b68cd0e67ce5ebb6ba4cd0e69ce5ebb6be0cd0e69ce5ebb6c1ccd0e69ce5ebb6c58cd0e67ce5ebb6c94cd0e6ace5ebb6cd0cd0e6ace5ebb6d0ccd0e68ce5ebb6d48cd0e6ace5ebb6d84cd0e6ace5ebb6dc0cd0e68ce5ebb6dfccd0e6ace5ebb6e38cd0e69ce5ebb6e74cd0e6cce5ebb6eb0cd0e69ce5ebb6eeccd0e6bce5ebb6f28cd0e6bce5ebb6f64cd0e69ce5ebb6fa0cd0e6ace5ebb6fdccd0e69ce5ebb7018cd0e6ace5ebb7054cd0e6ace5ebb7090cd0e6bce5ebb70cccd0e6cce5ebb7108cd0e6cce5ebb7144cd0e6ace5ebb7180cd0e6cce5ebb71bccd0e6ece5ebb71f8cd0e6cce5ebb7234cd0e6dce5ebb7270cd0e6ece5ebb72accd0e6fce5ebb72e8cd0e6fce5ebb7324cd0e6cce5ebb7360cd0e6dce5ebb739ccd0e6cce5ebb73d8cd0e6ece5ebb7414cd0e6fce5ebb7450cd0e6fce5ebb748ccd0e6fce5ebb74c8cd0e6fce5ebb7504cd0e6fce5ebb7540cd0e6fce5ebb757ccd0e70ce5ebb75b8cd0e6fce5ebb75f4cd0e70ce5ebb7630cd0e70ce5ebb766ccd0e71ce5ebb76a8cd0e72ce5ebb76e4cd0e72ce5ebb7720cd0e71ce5ebb775ccd0e71ce5ebb7798cd0e71ce5ebb77d4cd0e72ce5ebb7810cd0e72ce5ebb784ccd0e71ce5ebb7888cd0e70ce5ebb78c4cd0e71ce5ebb7900cd0e70ce5ebb793ccd0dc584a36d696ecd0daca36d6178cd1068a169cdea60a2696cce001b7740da004046df900da3a6d847fcdd4b527628b6f13eb056707c633e5f6e76d14e873bf2f3f595f29342eb61abf91f45fd42ba55ac1098736ecfa6fe1c942f77091eb2680b"

  private val trackleHardwareId2 = "d3f2b9b1-2990-c662-a7fa-95d6edc3a6be"
  private val trackleMsgPack2 = "96cd0013b0d3f2b9b12990c662a7fa95d6edc3a6beda004064112e7c852df606a208020dbd93ba9b22f4394ee4f15939f89c2f7e127169702c3cfc9154803b086a729be6b59b94490858392c713eb20b0fa5ac50fc62f0015495da002376312e302e322d50524f442d3230313830333236313033323035202876352e362e3629ce0001597403de01dace5f15f3e7cd0e03ce5f15f423cd0e14ce5f15f45fcd0e22ce5f15f49bcd0e2cce5f15f4d7cd0e34ce5f15f513cd0e3dce5f15f54fcd0e3ece5f15f58bcd0e43ce5f15f5c7cd0e43ce5f15f603cd0e45ce5f15f63fcd0e47ce5f15f67bcd0e48ce5f15f6b7cd0e4ace5f15f6f3cd0e4ace5f15f72fcd0e4bce5f15f76bcd0e4dce5f15f7a7cd0e4cce5f15f7e3cd0e4fce5f15f81fcd0e50ce5f15f85bcd0e4fce5f15f897cd0e4fce5f15f8d3cd0e51ce5f15f90fcd0e51ce5f15f94bcd0e50ce5f15f987cd0e52ce5f15f9c3cd0e52ce5f15f9ffcd0e52ce5f15fa3bcd0e54ce5f15fa77cd0e51ce5f15fab3cd0e54ce5f15faefcd0e54ce5f15fb2bcd0e54ce5f15fb67cd0e55ce5f15fba3cd0e54ce5f15fbdfcd0e57ce5f15fc1bcd0e59ce5f15fc57cd0e57ce5f15fc93cd0e56ce5f15fccfcd0e57ce5f15fd0bcd0e5ace5f15fd47cd0e59ce5f15fd83cd0e59ce5f15fdbfcd0e57ce5f15fdfbcd0e59ce5f15fe37cd0e5ace5f15fe73cd0e59ce5f15feafcd0e59ce5f15feebcd0e59ce5f15ff27cd0e5bce5f15ff63cd0e59ce5f15ff9fcd0e5bce5f15ffdbcd0e5ace5f160017cd0e5dce5f160053cd0e5bce5f16008fcd0e5ece5f1600cbcd0e5dce5f160107cd0e5bce5f160143cd0e5ece5f16017fcd0e5ece5f1601bbcd0e5dce5f1601f7cd0e5ece5f160233cd0e5ece5f16026fcd0e60ce5f1602abcd0e61ce5f1602e7cd0e60ce5f160323cd0e60ce5f16035fcd0e5fce5f16039bcd0e61ce5f1603d7cd0e62ce5f160413cd0e61ce5f16044fcd0e63ce5f16048bcd0e60ce5f1604c7cd0e62ce5f160503cd0e61ce5f16053fcd0e63ce5f16057bcd0e62ce5f1605b7cd0e61ce5f1605f3cd0e62ce5f16062fcd0e62ce5f16066bcd0e63ce5f1606a7cd0e63ce5f1606e3cd0e62ce5f16071fcd0e63ce5f16075bcd0e63ce5f160797cd0e64ce5f1607d3cd0e64ce5f16080fcd0e62ce5f16084bcd0e63ce5f160887cd0e63ce5f1608c3cd0e63ce5f1608ffcd0e61ce5f16093bcd0e64ce5f160977cd0e61ce5f1609b3cd0e62ce5f1609efcd0e61ce5f160a2bcd0e62ce5f160a67cd0e61ce5f160aa3cd0e61ce5f160adfcd0e62ce5f160b1bcd0e61ce5f160b57cd0e61ce5f160b93cd0e62ce5f160bcfcd0e62ce5f160c0bcd0e61ce5f160c47cd0e62ce5f160c83cd0e62ce5f160cbfcd0e62ce5f160cfbcd0e62ce5f160d37cd0e62ce5f160d73cd0e63ce5f160dafcd0e62ce5f160debcd0e64ce5f160e27cd0e64ce5f160e63cd0e65ce5f160e9fcd0e67ce5f160edbcd0e64ce5f160f17cd0e65ce5f160f53cd0e67ce5f160f8fcd0e68ce5f160fcbcd0e69ce5f161007cd0e68ce5f161043cd0e68ce5f16107fcd0e68ce5f1610bbcd0e69ce5f1610f7cd0e69ce5f161133cd0e69ce5f16116fcd0e69ce5f1611abcd0e69ce5f1611e7cd0e68ce5f161223cd0e67ce5f16125fcd0e6bce5f16129bcd0e67ce5f1612d7cd0e68ce5f161313cd0e64ce5f16134fcd0e65ce5f16138bcd0e68ce5f1613c7cd0e64ce5f161403cd0e63ce5f16143fcd0e64ce5f16147bcd0e63ce5f1614b7cd0e61ce5f1614f3cd0e62ce5f16152fcd0e61ce5f16156bcd0e60ce5f1615a7cd0e5ece5f1615e3cd0e5ece5f16161fcd0e5dce5f16165bcd0e5dce5f161697cd0e5cce5f1616d3cd0e5dce5f16170fcd0e5bce5f16174bcd0e5cce5f161787cd0e59ce5f1617c3cd0e57ce5f1617ffcd0e57ce5f16183bcd0e56ce5f161877cd0e56ce5f1618b3cd0e55ce5f1618efcd0e52ce5f16192bcd0e52ce5f161967cd0e52ce5f1619a3cd0e52ce5f1619dfcd0e51ce5f161a1bcd0e51ce5f161a57cd0e52ce5f161a93cd0e4ece5f161acfcd0e4fce5f161b0bcd0e4fce5f161b47cd0e4dce5f161b83cd0e4dce5f161bbfcd0e4cce5f161bfbcd0e4cce5f161c37cd0e4bce5f161c73cd0e4dce5f161cafcd0e4cce5f161cebcd0e4cce5f161d27cd0e4ace5f161d63cd0e4ace5f161d9fcd0e48ce5f161ddbcd0e47ce5f161e17cd0e47ce5f161e53cd0e48ce5f161e8fcd0e48ce5f161ecbcd0e48ce5f161f07cd0e46ce5f161f43cd0e46ce5f161f7fcd0e46ce5f161fbbcd0e46ce5f161ff7cd0e45ce5f162033cd0e44ce5f16206fcd0e43ce5f1620abcd0e43ce5f1620e7cd0e43ce5f162123cd0e43ce5f16215fcd0e43ce5f16219bcd0e42ce5f1621d7cd0e41ce5f162213cd0e42ce5f16224fcd0e41ce5f16228bcd0e42ce5f1622c7cd0e40ce5f162303cd0e42ce5f16233fcd0e44ce5f16237bcd0e40ce5f1623b7cd0e42ce5f1623f3cd0e3ece5f16242fcd0e40ce5f16246bcd0e3fce5f1624a7cd0e3fce5f1624e3cd0e40ce5f16251fcd0e40ce5f16255bcd0e40ce5f162597cd0e3fce5f1625d3cd0e41ce5f16260fcd0e40ce5f16264bcd0e3fce5f162687cd0e40ce5f1626c3cd0e41ce5f1626ffcd0e40ce5f16273bcd0e42ce5f162777cd0e42ce5f1627b3cd0e42ce5f1627efcd0e40ce5f16282bcd0e42ce5f162867cd0e40ce5f1628a3cd0e42ce5f1628dfcd0e42ce5f16291bcd0e42ce5f162957cd0e42ce5f162993cd0e40ce5f1629cfcd0e42ce5f162a0bcd0e43ce5f162a47cd0e42ce5f162a83cd0e41ce5f162abfcd0e3ece5f162afbcd0e40ce5f162b37cd0e41ce5f162b73cd0e43ce5f162bafcd0e41ce5f162bebcd0e40ce5f162c27cd0e41ce5f162c63cd0e41ce5f162c9fcd0e40ce5f162cdbcd0e43ce5f162d17cd0e42ce5f162d53cd0e44ce5f162d8fcd0e42ce5f162dcbcd0e3fce5f162e07cd0e3fce5f162e43cd0e40ce5f162e7fcd0e3ece5f162ebbcd0e3ece5f162ef7cd0e3ece5f162f33cd0e3ece5f162f6fcd0e3fce5f162fabcd0e3ece5f162fe7cd0e3fce5f163023cd0e3ece5f16305fcd0e3ece5f16309bcd0e40ce5f1630d7cd0e3fce5f163113cd0e3ece5f16314fcd0e40ce5f16318bcd0e40ce5f1631c7cd0e41ce5f163203cd0e40ce5f16323fcd0e3ece5f16327bcd0e3fce5f1632b7cd0e3fce5f1632f3cd0e3fce5f16332fcd0e3dce5f16336bcd0e3fce5f1633a7cd0e3ece5f1633e3cd0e3fce5f16341fcd0e3bce5f16345bcd0e3ece5f163497cd0e3dce5f1634d3cd0e3dce5f16350fcd0e3fce5f16354bcd0e3dce5f163587cd0e40ce5f1635c3cd0e3ece5f1635ffcd0e3fce5f16363bcd0e40ce5f163677cd0e3fce5f1636b3cd0e3ece5f1636efcd0e3ece5f16372bcd0e3dce5f163767cd0e3fce5f1637a3cd0e3ece5f1637dfcd0e3ece5f16381bcd0e3dce5f163857cd0e3fce5f163893cd0e3ece5f1638cfcd0e3dce5f16390bcd0e3fce5f163947cd0e42ce5f163983cd0e3ece5f1639bfcd0e3ece5f1639fbcd0e3ece5f163a37cd0e3dce5f163a73cd0e3ece5f163aafcd0e40ce5f163aebcd0e3fce5f163b27cd0e3ece5f163b63cd0e3fce5f163b9fcd0e3dce5f163bdbcd0e3dce5f163c17cd0e3dce5f163c53cd0e3ece5f163c8fcd0e3dce5f163ccbcd0e3fce5f163d07cd0e3dce5f163d43cd0e3dce5f163d7fcd0e3bce5f163dbbcd0e3dce5f163df7cd0e3dce5f163e33cd0e3bce5f163e6fcd0e3cce5f163eabcd0e3bce5f163ee7cd0e39ce5f163f23cd0e3dce5f163f5fcd0e3cce5f163f9bcd0e3cce5f163fd7cd0e3cce5f164013cd0e3cce5f16404fcd0e39ce5f16408bcd0e3dce5f1640c7cd0e3cce5f164103cd0e39ce5f16413fcd0e3bce5f16417bcd0e3ece5f1641b7cd0e3cce5f1641f3cd0e3dce5f16422fcd0e3ece5f16426bcd0e3dce5f1642a7cd0e3ece5f1642e3cd0e3ece5f16431fcd0e3ece5f16435bcd0e3dce5f164397cd0e3dce5f1643d3cd0e3dce5f16440fcd0e3cce5f16444bcd0e39ce5f164487cd0e39ce5f1644c3cd0e3bce5f1644ffcd0e3cce5f16453bcd0e3cce5f164577cd0e3bce5f1645b3cd0e39ce5f1645efcd0e3bce5f16462bcd0e3cce5f164667cd0e3bce5f1646a3cd0e3bce5f1646dfcd0e3cce5f16471bcd0e3bce5f164757cd0e39ce5f164793cd0e3bce5f1647cfcd0e3bce5f16480bcd0e3cce5f164847cd0e39ce5f164883cd0e3bce5f1648bfcd0e3bce5f1648fbcd0e3cce5f164937cd0e3cce5f164973cd0e3cce5f1649afcd0e3dce5f1649ebcd0e3dce5f164a27cd0e3ece5f164a63cd0e3ece5f164a9fcd0e3cce5f164adbcd0e3ece5f164b17cd0e3fce5f164b53cd0e3dce5f164b8fcd0e3ece5f164bcbcd0e3dce5f164c07cd0e3ece5f164c43cd0e3ece5f164c7fcd0e40ce5f164cbbcd0e3fce5f164cf7cd0e40ce5f164d33cd0e42ce5f164d6fcd0e40ce5f164dabcd0e40ce5f164de7cd0e44ce5f164e23cd0e43ce5f164e5fcd0e43ce5f164e9bcd0e44ce5f164ed7cd0e45ce5f164f13cd0e45ce5f164f4fcd0e44ce5f164f8bcd0e45ce5f164fc7cd0e46ce5f165003cd0e43ce5f16503fcd0e47ce5f16507bcd0e45ce5f1650b7cd0e47ce5f1650f3cd0e46ce5f16512fcd0e48ce5f16516bcd0e48ce5f1651a7cd0e46ce5f1651e3cd0e48ce5f16521fcd0e47ce5f16525bcd0e47ce5f165297cd0e48ce5f1652d3cd0e4bce5f16530fcd0e48ce5f16534bcd0e4ace5f165387cd0e48ce5f1653c3cd0e48ce5f1653ffcd0e4bce5f16543bcd0e48ce5f165477cd0e48ce5f1654b3cd0e4ace5f1654efcd0e48ce5f16552bcd0e48ce5f165567cd0e48ce5f1655a3cd0e4bce5f1655dfcd0e4bce5f16561bcd0e48ce5f165657cd0e46ce5f165693cd0e48ce5f1656cfcd0e48ce5f16570bcd0e4ace5f165747cd0e48ce5f165783cd0e48ce5f1657bfcd0e48ce5f1657fbcd0e48ce5f165837cd0e48ce5f165873cd0e4bce5f1658afcd0e4bce5f1658ebcd0e47ce5f165927cd0e4bce5f165963cd0e48ce5f16599fcd0e47ce5f1659dbcd0e48ce5f165a17cd0e46ce5f165a53cd0e48ce5f165a8fcd0e48ce5f165acbcd0e46ce5f165b07cd0e48ce5f165b43cd0e4ace5f165b7fcd0e4bce5f165bbbcd0e48ce5f165bf7cd0e48ce5f165c33cd0e48ce5f165c6fcd0e47ce5f165cabcd0e45ce5f165ce7cd0e45ce5f165d23cd0e46ce5f165d5fcd0e48ce5f165d9bcd0e43ce5f165dd7cd0e45ce5f165e13cd0e46ce5f165e4fcd0e45ce5f165e8bcd0e44ce5f165ec7cd0e44ce5f165f03cd0e45ce5f165f3fcd0e44ce5f165f7bcd0e44ce5f165fb7cd0e46ce5f165ff3cd0e44ce5f16602fcd0e45ce5f16606bcd0e45ce5f1660a7cd0e45ce5f1660e3cd0e47ce5f16611fcd0e47ce5f16615bcd0e45ce5f166197cd0e47ce5f1661d3cd0e48ce5f16620fcd0e47ce5f16624bcd0e46ce5f166287cd0e48ce5f1662c3cd0e4784a36d696ecd0daca36d6178cd1068a169cdea60a2696cce001b7740da0040d4857ced59e325acf159ec75c2c64963f9f9332fc354e4c13499f5a1928cd25a97db53d9784c097f760c2b156824da84b905284952f5efd145237c44fca84e05"

  private val keyServerClient = (c: NioMicroservice.Context) => new CachingUbirchKeyService(c) {

    private val eddsaKey = GeneratorKeyFactory.getPubKey(
      "55f0feac4f2bcf879330eff348422ab3abf5237a24acaf0aef3bb876045c4e532fbd6cd8e265f6cf28b46e7e4512cd06ba84bcd3300efdadf28750f43dafd771",
      curveFromString("ecdsa-p256v1")
    )

    private val waldisKey = GeneratorKeyFactory.getPubKey(
      Base64.getDecoder.decode("7odnHwchQA6AAk8AZzCQevnWM2PT4Jg+MSxVDf7wGsU="),
      curveFromString("ECC_ED25519")
    )

    private val trackleKey = GeneratorKeyFactory.getPubKey(
      Base64.getDecoder.decode("Lujc3SSchaqzGn/wDZWzmRfwVgdCZBoW6QkLT7N1700="),
      curveFromString("ECC_ED25519")
    )


    private val trackleKey2 = GeneratorKeyFactory.getPubKey(
      Base64.getDecoder.decode("GYbn+t0zb6yva8eDo29IoHqXF+lHtWSPhyJ+TY4MU00="),
      curveFromString("ECC_ED25519")
    )

    override def getPublicKey(uuid: UUID): List[PubKey] = {
      uuid.toString match {
        case id if id == v2HardwareId => List(eddsaKey)
        case id if id == v1HardwareId => List(waldisKey)
        case id if id == trackleHardwareId => List(trackleKey)
        case id if id == trackleHardwareId2 => List(trackleKey2)
        case _ => Nil
      }
    }
  }

  private val microservice = NioMicroserviceMock(MessageDecodingMicroservice(c => new DefaultProtocolVerifier(keyServerClient(c))))
  microservice.outputTopics = Map("valid" -> "valid")
  microservice.errorTopic = Some("invalid")
  microservice.config = ConfigFactory.load().getConfig("niomon-decoder")
  microservice.name = "niomon-decoder"

  import microservice.kafkaMocks._

  "MessageDecodingMicroservice.Routing" should "be routed to 'valid' queue when msgpackv2 with valid signature" in {
    val binary = DatatypeConverter.parseHexBinary(v2MsgPackHex)
    val record = new ProducerRecord[String, Array[Byte]]("incoming", binary)
      .withExtraHeaders("X-Ubirch-Hardware-Id".toLowerCase -> v2HardwareId)
      .withRequestIdHeader()("foo")

    publishToKafka(record)

    val validTopicEnvelopes = consumeNumberMessagesFrom("valid", 1, autoCommit = true)
    validTopicEnvelopes.size should be(1)

    val approvedMessage = validTopicEnvelopes.head
    val msg = parse(new ByteArrayInputStream(approvedMessage)) \ "ubirchPacket"
    (msg \ "signed").extract[String] should equal("lSLEEG6sTQsW5kUIjEYi50UepaEAxCBrhrJz/zT84Z1rgE7/Wj9XR62k6qIvHUnAHlLdt4dbSw==")
    (msg \ "version").extract[Int] should be(34)
    (msg \ "hint").extract[Int] should be(0x00)
    (msg \ "uuid").extract[String] should equal(v2HardwareId)
    (msg \ "payload").extract[String] should be("a4ayc/80/OGda4BO/1o/V0etpOqiLx1JwB5S3beHW0s=")
  }

  it should "be routed to 'valid' queue when msgpackv1 has valid signature" in {
    val binary = Hex.decodeHex(v1MsgPackHex)
    val record = new ProducerRecord[String, Array[Byte]]("incoming", binary)
      .withExtraHeaders("X-Ubirch-Hardware-Id".toLowerCase -> v1HardwareId)
      .withRequestIdHeader()("foo")

    publishToKafka(record)

    val validTopicEnvelopes = consumeNumberMessagesFrom("valid", 1, autoCommit = true)
    validTopicEnvelopes.size should be(1)

    val approvedMessage = validTopicEnvelopes.head
    val msg = parse(new ByteArrayInputStream(approvedMessage)) \ "ubirchPacket"
    (msg \ "signed").extract[String] should equal("lhOwlGunVeEyRoCjgHvjleuMzdoAQAHTx4p7yHOMur7pauhmUciaqBJS3uDnx/NFcyQgKq6cPRYzLT1+zecvomgBoIG2NHFIuuarIriDDDYNeNC2Pw4ApQECAwQF")
    (msg \ "version").extract[Int] should be(35)
    (msg \ "hint").extract[Int] should be(0x00)
    (msg \ "uuid").extract[String] should equal(v1HardwareId)
    (msg \ "payload").extract[String] should be("AQIDBAU=")

  }

  it should "be routed to 'invalid' queue when msgpackv1 has invalid upp" in {
    val binary = DatatypeConverter.parseHexBinary(v1MsgPackHex).reverse.tail.reverse
    val record = new ProducerRecord[String, Array[Byte]]("incoming", binary)
      .withExtraHeaders("X-Ubirch-Hardware-Id".toLowerCase -> v1HardwareId)
      .withRequestIdHeader()("foo")

    publishToKafka(record)

    val invalidTopicEnvelopes = consumeNumberStringMessagesFrom("invalid", 1, autoCommit = true)
    invalidTopicEnvelopes.size should be(1)

    val rejectedMessage = invalidTopicEnvelopes.head
    rejectedMessage should equal("""{"error":"IllegalArgumentException: Invalid parts for verification","causes":[],"microservice":"niomon-decoder","requestId":"foo"}""")
  }

  it should "be routed to 'invalid' queue when msgpackv1 has invalid signature" in {
    val binary = DatatypeConverter.parseHexBinary(v1MsgPackHex).dropRight(1) ++ Array(7.toByte)

    val record = new ProducerRecord[String, Array[Byte]]("incoming", binary)
      .withExtraHeaders("X-Ubirch-Hardware-Id".toLowerCase -> v1HardwareId) // Wrong uuid
      .withRequestIdHeader()("foo")

    publishToKafka(record)

    val invalidTopicEnvelopes = consumeNumberStringMessagesFrom("invalid", 1, autoCommit = true)
    invalidTopicEnvelopes.size should be(1)

    val rejectedMessage = invalidTopicEnvelopes.head
    rejectedMessage should equal("""{"error":"SignatureException: Invalid signature","causes":[],"microservice":"niomon-decoder","requestId":"foo"}""")
  }

  it should "be routed to 'invalid' queue when no hwDeviceId in the header is found" in {
    val binary = DatatypeConverter.parseHexBinary(v1MsgPackHex + "12")
    val record = new ProducerRecord[String, Array[Byte]]("incoming", binary).withRequestIdHeader()("foo")
    publishToKafka(record)

    val invalidTopicEnvelopes = consumeNumberMessagesFrom("invalid", 1, autoCommit = true)
    invalidTopicEnvelopes.size should be(1)

    val rejectedMessage: Array[Byte] = invalidTopicEnvelopes.head
    rejectedMessage.map(_.toChar).mkString should equal("{\"error\":\"NoSuchElementException: Header with key x-ubirch-hardware-id is missing. Cannot verify msgpack.\",\"causes\":[],\"microservice\":\"niomon-decoder\",\"requestId\":\"foo\"}")
  }

  it should "be routed to 'valid' queue when trackleMsg has valid signature" in {
    val binary = DatatypeConverter.parseHexBinary(trackleMsgPack)
    val record = new ProducerRecord[String, Array[Byte]]("incoming", binary)
      .withExtraHeaders("X-Ubirch-Hardware-Id".toLowerCase -> trackleHardwareId)
      .withRequestIdHeader()("foo")

    publishToKafka(record)

    val validTopicEnvelopes = consumeNumberMessagesFrom("valid", 1, autoCommit = true)
    validTopicEnvelopes.size should be(1)

    val approvedMessage = validTopicEnvelopes.head
    val msg = parse(new ByteArrayInputStream(approvedMessage)) \ "ubirchPacket"
    (msg \ "signed").extract[String] should equal("ls0AE7B6pC6p+YGRppucsUqsq85U2gBAhjrxoe1dEFFWareYlzR7Nrhs8lU++4UJoT5EAnbjMnZT+dAqCaspBIA9/WtjKXLxELMgkPOnBlkgVMWteSzhAlSV2gAjdjEuMC4yLVBST0QtMjAxODAzMjYxMDMyMDUgKHY1LjYuNinNFaoD3gHtzl67BevNDmrOXrsGJ80Oas5euwZjzQ5qzl67Bp/NDmrOXrsG280Oac5euwcXzQ5pzl67B1PNDmjOXrsHj80Oac5euwfLzQ5nzl67CAfNDmXOXrsIQ80OZM5euwh/zQ5kzl67CLvNDmTOXrsI980OYc5euwkzzQ5fzl67CW/NDl/OXrsJq80OXc5euwnnzQ5ezl67CiPNDl7OXrsKX80OXM5euwqbzQ5bzl67CtfNDlnOXrsLE80OV85euwtPzQ5Vzl67C4vNDlTOXrsLx80OVc5euwwDzQ5Tzl67DD/NDlXOXrsMe80OVs5euwy3zQ5Uzl67DPPNDlLOXrsNL80OUs5euw1rzQ5Szl67DafNDlXOXrsN480OVs5euw4fzQ5Uzl67DlvNDlTOXrsOl80OVM5euw7TzQ5Uzl67Dw/NDlbOXrsPS80OVM5euw+HzQ5Wzl67D8PNDlbOXrsP/80OV85euxA7zQ5Xzl67EHfNDlnOXrsQs80OV85euxDvzQ5Vzl67ESvNDlfOXrsRZ80OVs5euxGjzQ5Xzl67Ed/NDlXOXrsSG80OVs5euxJXzQ5Vzl67EpPNDlbOXrsSz80OVM5euxMLzQ5Szl67E0fNDlLOXrsTg80OUs5euxO/zQ5Szl67E/vNDlTOXrsUN80OVM5euxRzzQ5Uzl67FK/NDlTOXrsU680OU85euxUnzQ5Uzl67FWPNDlLOXrsVn80OUs5euxXbzQ5Rzl67FhfNDlTOXrsWU80OUs5euxaPzQ5Szl67FsvNDlLOXrsXB80OUs5euxdDzQ5Rzl67F3/NDlLOXrsXu80OUc5euxf3zQ5Szl67GDPNDlPOXrsYb80OVc5euxirzQ5Szl67GOfNDlTOXrsZI80OU85euxlfzQ5Szl67GZvNDlPOXrsZ180OVM5euxoTzQ5Vzl67Gk/NDlTOXrsai80OVM5euxrHzQ5Tzl67GwPNDlXOXrsbP80OU85euxt7zQ5Uzl67G7fNDlPOXrsb880OVs5euxwvzQ5Tzl67HGvNDlXOXrscp80OVs5euxzjzQ5Zzl67HR/NDlnOXrsdW80OV85eux2XzQ5Wzl67HdPNDlTOXrseD80OV85eux5LzQ5Zzl67HofNDlbOXrsew80OVs5eux7/zQ5Wzl67HzvNDlnOXrsfd80OVs5eux+zzQ5Zzl67H+/NDlnOXrsgK80OV85euyBnzQ5azl67IKPNDlvOXrsg380OWs5euyEbzQ5azl67IVfNDlzOXrshk80OW85euyHPzQ5bzl67IgvNDlvOXrsiR80OXc5euyKDzQ5dzl67Ir/NDlzOXrsi+80OW85euyM3zQ5Zzl67I3PNDlvOXrsjr80OXM5euyPrzQ5czl67JCfNDlzOXrskY80OXc5euySfzQ5dzl67JNvNDl3OXrslF80OXc5euyVTzQ5ezl67JY/NDmDOXrsly80OX85euyYHzQ5fzl67JkPNDl/OXrsmf80OXs5euya7zQ5ezl67JvfNDl3OXrsnM80OX85euydvzQ5hzl67J6vNDmHOXrsn580OXs5euygjzQ5fzl67KF/NDmHOXrsom80OYs5euyjXzQ5izl67KRPNDmDOXrspT80OYs5euymLzQ5izl67KcfNDmLOXrsqA80OYc5euyo/zQ5izl67KnvNDmPOXrsqt80OYs5euyrzzQ5jzl67Ky/NDmTOXrsra80OYs5euyunzQ5kzl67K+PNDmTOXrssH80OY85euyxbzQ5kzl67LJfNDmfOXrss080OZc5euy0PzQ5kzl67LUvNDmjOXrsth80OaM5euy3DzQ5nzl67Lf/NDmjOXrsuO80OaM5euy53zQ5pzl67LrPNDmnOXrsu780Oac5euy8rzQ5pzl67L2fNDmzOXrsvo80Oa85euy/fzQ5rzl67MBvNDmzOXrswV80Obc5euzCTzQ5szl67MM/NDm3OXrsxC80Obs5euzFHzQ5vzl67MYPNDm7OXrsxv80Ob85euzH7zQ5tzl67MjfNDm/OXrsyc80Ob85euzKvzQ5vzl67MuvNDm/OXrszJ80Obs5euzNjzQ5vzl67M5/NDm/OXrsz280Obs5euzQXzQ5vzl67NFPNDm3OXrs0j80Obs5euzTLzQ5vzl67NQfNDm/OXrs1Q80Ob85euzV/zQ5yzl67NbvNDnLOXrs1980OcM5euzYzzQ5vzl67Nm/NDnDOXrs2q80OcM5euzbnzQ5xzl67NyPNDnHOXrs3X80Occ5euzebzQ5yzl67N9fNDnTOXrs4E80Occ5euzhPzQ5zzl67OIvNDnTOXrs4x80OdM5euzkDzQ5zzl67OT/NDnLOXrs5e80OcM5euzm3zQ5yzl67OfPNDnLOXrs6L80Occ5euzprzQ50zl67OqfNDm/OXrs6480Ocs5euzsfzQ5wzl67O1vNDnHOXrs7l80Occ5euzvTzQ5wzl67PA/NDm/OXrs8S80Ob85euzyHzQ5uzl67PMPNDmzOXrs8/80ObM5euz07zQ5szl67PXfNDm7OXrs9s80Oa85euz3vzQ5qzl67PivNDm3OXrs+Z80Oac5euz6jzQ5pzl67Pt/NDmrOXrs/G80Oac5euz9XzQ5qzl67P5PNDmfOXrs/z80OZ85eu0ALzQ5nzl67QEfNDmPOXrtAg80OZM5eu0C/zQ5izl67QPvNDmLOXrtBN80OY85eu0FzzQ5izl67Qa/NDmLOXrtB680OYc5eu0InzQ5ezl67QmPNDl/OXrtCn80OX85eu0LbzQ5gzl67QxfNDl7OXrtDU80OXc5eu0OPzQ5czl67Q8vNDlvOXrtEB80OW85eu0RDzQ5azl67RH/NDlvOXrtEu80OXM5eu0T3zQ5czl67RTPNDl3OXrtFb80OYM5eu0WrzQ5dzl67RefNDl7OXrtGI80OYM5eu0ZfzQ5ezl67RpvNDl3OXrtG180OXM5eu0cTzQ5fzl67R0/NDl/OXrtHi80OXs5eu0fHzQ5ezl67SAPNDl/OXrtIP80OYM5eu0h7zQ5fzl67SLfNDl7OXrtI880OXs5eu0kvzQ5ezl67SWvNDl7OXrtJp80OYM5eu0njzQ5gzl67Sh/NDl7OXrtKW80OX85eu0qXzQ5ezl67StPNDl7OXrtLD80OXs5eu0tLzQ5ezl67S4fNDl3OXrtLw80OXs5eu0v/zQ5fzl67TDvNDl7OXrtMd80OXc5eu0yzzQ5ezl67TO/NDl3OXrtNK80OYM5eu01nzQ5dzl67TaPNDl7OXrtN380OYM5eu04bzQ5ezl67TlfNDmDOXrtOk80OXc5eu07PzQ5ezl67TwvNDl7OXrtPR80OX85eu0+DzQ5ezl67T7/NDl/OXrtP/M0OXs5eu1A4zQ5ezl67UHTNDl7OXrtQsM0OXc5eu1DszQ5dzl67USjNDl7OXrtRZM0OXc5eu1GgzQ5ezl67UdzNDlzOXrtSGM0OXs5eu1JUzQ5ezl67UpDNDl3OXrtSzM0OXc5eu1MIzQ5ezl67U0TNDl3OXrtTgM0OXs5eu1O8zQ5ezl67U/jNDl7OXrtUNM0OXs5eu1RwzQ5dzl67VKzNDl7OXrtU6M0OXs5eu1UkzQ5dzl67VWDNDl7OXrtVnM0OXc5eu1XYzQ5ezl67VhTNDl3OXrtWUM0OXc5eu1aMzQ5fzl67VsjNDl7OXrtXBM0OXs5eu1dAzQ5czl67V3zNDl3OXrtXuM0OXs5eu1f0zQ5ezl67WDDNDlzOXrtYbM0OXc5eu1iozQ5czl67WOTNDl3OXrtZIM0OXc5eu1lczQ5ezl67WZjNDl/OXrtZ1M0OYM5eu1oQzQ5dzl67WkzNDlvOXrtaiM0OXc5eu1rEzQ5czl67WwDNDl3OXrtbPM0OXs5eu1t4zQ5ezl67W7TNDl3OXrtb8M0OXc5eu1wszQ5ezl67XGjNDl3OXrtcpM0OXc5eu1zgzQ5ezl67XRzNDl/OXrtdWM0OYc5eu12UzQ5gzl67XdDNDmHOXrteDM0OXs5eu15IzQ5fzl67XoTNDl7OXrtewM0OXc5eu178zQ5fzl67XzjNDl3OXrtfdM0OXs5eu1+wzQ5ezl67X+zNDmDOXrtgKM0OX85eu2BkzQ5hzl67YKDNDmHOXrtg3M0OYs5eu2EYzQ5izl67YVTNDmLOXrthkM0OZM5eu2HMzQ5izl67YgjNDmTOXrtiRM0OZc5eu2KAzQ5lzl67YrzNDmXOXrti+M0OZc5eu2M0zQ5nzl67Y3DNDmPOXrtjrM0OZc5eu2PozQ5jzl67ZCTNDmTOXrtkYM0OY85eu2SczQ5kzl67ZNjNDmTOXrtlFM0Oac5eu2VQzQ5lzl67ZYzNDmfOXrtlyM0OZc5eu2YEzQ5nzl67ZkDNDmfOXrtmfM0OZ85eu2a4zQ5nzl67ZvTNDmfOXrtnMM0OZ85eu2dszQ5nzl67Z6jNDmTOXrtn5M0OZM5eu2ggzQ5nzl67aFzNDmTOXrtomM0OZM5eu2jUzQ5nzl67aRDNDmXOXrtpTM0OZ85eu2mIzQ5ozl67acTNDmjOXrtqAM0OZ85eu2o8zQ5pzl67anjNDmjOXrtqtM0OZ85eu2rwzQ5ozl67ayzNDmjOXrtraM0OZ85eu2ukzQ5pzl67a+DNDmnOXrtsHM0Oac5eu2xYzQ5nzl67bJTNDmrOXrts0M0Oas5eu20MzQ5ozl67bUjNDmrOXrtthM0Oas5eu23AzQ5ozl67bfzNDmrOXrtuOM0Oac5eu250zQ5szl67brDNDmnOXrtu7M0Oa85eu28ozQ5rzl67b2TNDmnOXrtvoM0Oas5eu2/czQ5pzl67cBjNDmrOXrtwVM0Oas5eu3CQzQ5rzl67cMzNDmzOXrtxCM0ObM5eu3FEzQ5qzl67cYDNDmzOXrtxvM0Obs5eu3H4zQ5szl67cjTNDm3OXrtycM0Obs5eu3KszQ5vzl67cujNDm/OXrtzJM0ObM5eu3NgzQ5tzl67c5zNDmzOXrtz2M0Obs5eu3QUzQ5vzl67dFDNDm/OXrt0jM0Ob85eu3TIzQ5vzl67dQTNDm/OXrt1QM0Ob85eu3V8zQ5wzl67dbjNDm/OXrt19M0OcM5eu3YwzQ5wzl67dmzNDnHOXrt2qM0Ocs5eu3bkzQ5yzl67dyDNDnHOXrt3XM0Occ5eu3eYzQ5xzl67d9TNDnLOXrt4EM0Ocs5eu3hMzQ5xzl67eIjNDnDOXrt4xM0Occ5eu3kAzQ5wzl67eTzNDcWEo21pbs0NrKNtYXjNEGihac3qYKJpbM4AG3dA")
    (msg \ "version").extract[Int] should be(35)
    (msg \ "uuid").extract[String] should equal(trackleHardwareId)
  }

  it should "be routed to 'valid' queue when trackleMsg with valid signature 2" in {
    val binary = DatatypeConverter.parseHexBinary(trackleMsgPack2)
    val record = new ProducerRecord[String, Array[Byte]]("incoming", binary)
      .withExtraHeaders("X-Ubirch-Hardware-Id".toLowerCase -> trackleHardwareId2)
      .withRequestIdHeader()("foo")

    publishToKafka(record)

    val validTopicEnvelopes = consumeNumberMessagesFrom("valid", 1, autoCommit = true)
    validTopicEnvelopes.size should be(1)

    val approvedMessage = validTopicEnvelopes.head
    val msg = parse(new ByteArrayInputStream(approvedMessage)) \ "ubirchPacket"
    (msg \ "version").extract[Int] should be(35)
    (msg \ "uuid").extract[String] should equal(trackleHardwareId2)
  }

}
